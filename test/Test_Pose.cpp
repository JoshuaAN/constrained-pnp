#include <gtest/gtest.h>

#include <constrained_pnp.h>

TEST(Pose, Naive) {
    cpnp::ProblemParams params(4);

    params.worldPoints << 
-4.38785,   -4.22275,   -4.22275,  -4.38785, 
-0.14123904,-0.14123904,-0.3054346,-0.3054346,
3.96938119, 3.96938119, 3.95212354,3.95212354,
1,          1,          1,         1;


/*
world_points
array([[-4.38785   , -0.14123904,  3.96938119],
       [-4.22275   , -0.14123904,  3.96938119],
       [-4.22275   , -0.3054346 ,  3.95212354],
       [-4.38785   , -0.3054346 ,  3.95212354],
       [-3.626993  , -0.17728208,  4.31230785],
       [-3.544443  , -0.19222765,  4.45450538],
       [-3.544443  , -0.35642321,  4.43724773],
       [-3.626993  , -0.34147765,  4.2950502 ],
       [-0.27559   , -1.38161781,  6.2647928 ],
       [-0.27559   , -1.36436016,  6.10059724],
       [-0.27559   , -1.52855573,  6.08333959],
       [-0.27559   , -1.54581338,  6.24753515],
       [-5.066157  , -0.19222765,  4.45450538],
       [-4.983607  , -0.17728208,  4.31230785],
       [-4.983607  , -0.34147765,  4.2950502 ],
       [-5.066157  , -0.35642321,  4.43724773],
       [-2.276856  , -2.19018622,  8.43562142],
       [-2.111756  , -2.19018622,  8.43562142],
       [-2.111756  , -2.32375492,  8.33857807],
       [-2.276856  , -2.32375492,  8.33857807],
       [-6.499606  , -2.19018622,  8.43562142],
       [-6.334506  , -2.19018622,  8.43562142],
       [-6.334506  , -2.32375492,  8.33857807],
       [-6.499606  , -2.32375492,  8.33857807],
       [-4.38785   , -1.03701724, 12.49214144],
       [-4.22275   , -1.03701724, 12.49214144],
       [-4.22275   , -1.2012128 , 12.47488379],
       [-4.38785   , -1.2012128 , 12.47488379]])
*/

    params.imagePoints << 
        401.35592651, 434.62026978, 434.35839844, 400.89996338, 
        352.10610962, 352.10610962, 318.79934692, 318.79934692;

/*
image_points
array([[[401.35592651, 352.10610962]],
       [[434.62026978, 352.10610962]],
       [[434.35839844, 318.79934692]],
       [[400.89996338, 318.79934692]],
       [[546.88555908, 346.36123657]],
       [[558.41638184, 344.31311035]],
       [[558.81201172, 315.66061401]],
       [[547.23791504, 316.48504639]],
       [[903.06799316, 214.3102417 ]],
       [[916.68865967, 211.66645813]],
       [[918.17126465, 191.83242798]],
       [[904.45953369, 195.1048584 ]],
       [[294.80895996, 344.31311035]],
       [[301.80636597, 346.36123657]],
       [[300.8772583 , 316.48504639]],
       [[293.88314819, 315.66061401]],
       [[618.29797363, 191.56022644]],
       [[631.59661865, 191.56022644]],
       [[633.60644531, 178.44384766]],
       [[620.13201904, 178.44384766]],
       [[278.15863037, 191.56022644]],
       [[291.45727539, 191.56022644]],
       [[288.97250366, 178.44384766]],
       [[275.49810791, 178.44384766]],
       [[459.28125   , 310.90591431]],
       [[467.88793945, 310.90591431]],
       [[467.8704834 , 302.26342773]],
       [[459.25085449, 302.26342773]]])
*/

    params.K << 
599.375     ,   0.        , 479.5      ,
 0.        , 599.16666667, 359.5       ,
 0.        ,   0.        ,   1.        ;

/*
K
array([[599.375     ,   0.        , 479.5       ],
       [  0.        , 599.16666667, 359.5       ],
       [  0.        ,   0.        ,   1.        ]])
*/

    auto ret = cpnp::solve_naive(params);

    fmt::println("Robot is at:\n{}", ret.ToMatrix());
}
